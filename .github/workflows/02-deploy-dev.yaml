name: 02 - Deploy Status App (Dev)

on:
  workflow_run:
    workflows: ["01 - Build & Push Status App Image"]
    types: [ completed ]
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure + Upload init.sql + Set KV Secret
        working-directory: apps/dev apps/status-app
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          IMAGE_TAG: ${{ github.sha }}  # Use commit SHA as fallback tag (simple!)
        run: |
          Write-Host "Deploying infra using commit: $env:IMAGE_TAG"
          ./deploy.ps1 -Environment dev

      - name: Update App Service to Latest Image
        run: |
          # Use short SHA from commit (matches build workflow)
          $shortSha = $env:GITHUB_SHA.Substring(0,7)
          Write-Host "Updating App Service to image tag: $shortSha"
          
          az webapp config container set `
            --name statusapp-dev `
            --resource-group rg-dev-statusapp `
            --docker-custom-image-name ${{ vars.ACR_NAME }}.azurecr.io/status-app:$shortSha `
            --docker-registry-server-url https://${{ vars.ACR_NAME }}.azurecr.io